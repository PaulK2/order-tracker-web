<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Orders • Order Tracker</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="notice" class="notice"></div>

  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div>Web Order Tracker</div>
        <div class="badge">Web</div>
      </div>

      <nav class="nav">
        <a href="index.html" class="active">Open Orders</a>
        <a href="finished.html">Finished</a>
        <a href="notes.html">Notes</a>
        <a href="links.html">Links</a>
        <a href="kb.html">Knowledge Base</a>
        <a href="settings.html">Settings</a>
        <a href="info.html">Info</a>
      </nav>

      <div class="userbox">
        <div class="pill"><span class="muted">User:</span> <b data-user>—</b></div>
        <div class="pill" data-open>Open: 0</div>
        <div class="pill" data-finished>Finished: 0</div>
        <button class="ghost" data-switch-user>Switch</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="previewBanner" class="banner">
      <b>Preview mode</b> – saving is disabled.
    </div>

    <!-- TOP TOOLBAR -->
    <section class="card">
      <div class="card-b stack">
        <div class="row">
          <input id="search" placeholder="Search (name / 310 / 42 / 23)" style="min-width:260px" />
          <select id="sort" style="min-width:160px">
            <option>Created</option>
            <option>Name A→Z</option>
            <option>Name Z→A</option>
            <option>310x</option>
            <option>42x</option>
            <option>23x</option>
          </select>
          <select id="catFilter" style="min-width:200px"></select>
          <div style="flex:1"></div>
          <button class="primary" id="toggleAdd">+ Add Order</button>
        </div>

        <!-- ADD FORM -->
        <div id="addForm" class="row" style="display:none">
          <input id="name" placeholder="Name" style="min-width:220px" />
          <input id="v310" placeholder="310x" style="width:140px" />
          <input id="v42" placeholder="42x" style="width:140px" />
          <select id="category" style="min-width:180px"></select>
          <button class="primary" id="addBtn">Add</button>
        </div>
      </div>
    </section>

    <!-- OPEN ORDERS LIST -->
    <section class="stack" id="orders"></section>

  </main>

  <script src="app.js"></script>
  <script>
    OT.initCommon();

    const $ = OT.byId;
    const ordersRoot = $("orders");

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    const searchInp = $("search");
    const sortSel = $("sort");
    const catFilter = $("catFilter");
    const catSel = $("category");

    $("toggleAdd").onclick = () => {
      const f = $("addForm");
      f.style.display = f.style.display === "none" ? "flex" : "none";
    };

    function fillCategories(){
      const names = OT.categoryNames();

      catSel.innerHTML = "";
      names.forEach(n => {
        const o = document.createElement("option");
        o.value = n;
        o.textContent = n;
        catSel.appendChild(o);
      });

      catFilter.innerHTML = "";
      const all = document.createElement("option");
      all.value = "All";
      all.textContent = "All categories";
      catFilter.appendChild(all);

      names.forEach(n => {
        const o = document.createElement("option");
        o.value = n;
        o.textContent = n;
        catFilter.appendChild(o);
      });
    }

    function filtered(){
      let arr = [...OT.State.data.open];
      const q = searchInp.value.toLowerCase().trim();
      const cat = catFilter.value;

      if(q){
        arr = arr.filter(o =>
          (o.name||"").toLowerCase().includes(q) ||
          (o.val310||"").includes(q) ||
          (o.val42||"").includes(q) ||
          (o.val23||"").includes(q)
        );
      }

      if(cat && cat !== "All"){
        arr = arr.filter(o => o.category === cat);
      }

      const mode = sortSel.value;
      if(mode === "Name A→Z") arr.sort((a,b)=>a.name.localeCompare(b.name));
      else if(mode === "Name Z→A") arr.sort((a,b)=>b.name.localeCompare(a.name));
      else if(mode === "310x") arr.sort((a,b)=>String(a.val310).localeCompare(b.val310));
      else if(mode === "42x") arr.sort((a,b)=>String(a.val42).localeCompare(b.val42));
      else if(mode === "23x") arr.sort((a,b)=>String(a.val23||"").localeCompare(b.val23||""));
      else arr.sort((a,b)=>b.id-a.id);

      return arr;
    }

    function render(){
      OT.clear(ordersRoot);
      fillCategories();

      const list = filtered();
      if(!list.length){
        ordersRoot.appendChild(OT.el(`<div class="muted">No open orders.</div>`));
        return;
      }

      list.forEach(o=>{
        o.notes ||= [];
        const cat = OT.categoryByName(o.category||"Default");
        const lastNote = o.notes.length ? escapeHtml(o.notes[o.notes.length-1].text).slice(0,180) : "";

        const card = OT.el(`
          <div class="card order" style="border-left-color:${cat.color}">
            <div class="card-b">
              <div class="title">${escapeHtml(o.name)}</div>
              <div class="meta">
                310x: ${o.val310} | 42x: ${o.val42} | 23x: ${o.val23||""} | ${o.category}
              </div>

              ${lastNote ? `
                <div class="muted small" style="margin-top:6px">
                  <b>Last note:</b> ${lastNote}
                </div>` : ""
              }

              <div class="row end" style="margin-top:10px">
                <button class="ghost" data-finish>Finish</button>
                <button class="bad" data-remove>Remove</button>
              </div>
            </div>
          </div>
        `);

        card.querySelector("[data-finish]").onclick = ()=>{
          OT.State.data.open = OT.State.data.open.filter(x=>x!==o);
          OT.State.data.finished.push(o);
          OT.saveUser();
          render();
        };

        card.querySelector("[data-remove]").onclick = ()=>{
          if(!confirm(`Remove order '${o.name}'?`)) return;
          OT.State.data.open = OT.State.data.open.filter(x=>x!==o);
          OT.saveUser();
          render();
        };

        ordersRoot.appendChild(card);
      });
    }

    $("addBtn").onclick = ()=>{
      const name = $("name").value.trim();
      const v310 = $("v310").value.trim();
      const v42 = $("v42").value.trim();
      const cat = catSel.value;

      if(!name || !v310 || !v42) return OT.toast("Fill all fields", "bad");

      OT.State.data.open.push(OT.makeOrder({
        name,
        val310: v310,
        val42: v42,
        category: cat
      }));

      $("name").value = $("v310").value = $("v42").value = "";
      OT.saveUser();
      render();
    };

    [searchInp, sortSel, catFilter].forEach(e => e.addEventListener("input", render));

    render();
  </script>
</body>
</html>
